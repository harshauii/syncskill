<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uPVC Pro - Order Dashboard</title>
    <!-- Google Fonts for IBM Plex Sans & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- 1. MODERN DESIGN SYSTEM & UI PALETTE --- */
        :root {
            --font-main: "IBM Plex Sans", ui-sans-serif, system-ui, sans-serif;
            --font-icon: "Material Symbols Outlined";
            
            --light-bg-primary: #ffffff;
            --light-bg-secondary: #f7f9fc;
            --light-bg-tertiary: #f1f3f6;

            --light-text-primary: #012726; /* Dark Teal */
            --light-text-secondary: #52616b;
            --light-text-muted: #9ca3af;

            --light-border: #e5e7eb;
            --light-border-hover: #d1d5db;

            --color-primary: #012726; /* Dark Teal */
            --color-primary-hover: #023d3c;
            --color-primary-text: #ffffff;

            --color-accent: #33C375; /* Green Accent */
            --color-accent-hover: #2CAC66;
            --color-accent-text: #012726;

            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-danger-text: #ffffff;
            
            --color-reopen: #6f42c1;
            --color-reopen-hover: #5a3d9a;
            --color-reopen-text: #ffffff;

            --status-pending-bg: #eef2ff;
            --status-pending-text: #4338ca;
            --status-completed-bg: #f0fdf4;
            --status-completed-text: #166534;
            --status-overdue-bg: #fff1f2;
            --status-overdue-text: #be123c;
            --status-upcoming-bg: #fefce8;
            --status-upcoming-text: #854d0e;
            
            --color-focus-ring: rgba(51, 195, 117, 0.35);
            --radius-sm: 0.25rem; /* 4px */
            --radius-md: 0.5rem;  /* 8px */
            --radius-lg: 1rem;    /* 16px */
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.04);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --shadow-lg: 0 10px 20px -3px rgb(0 0 0 / 0.07), 0 4px 8px -4px rgb(0 0 0 / 0.07);
            --ease: cubic-bezier(.4,0,.2,1);
        }

        /* --- 2. BASE STYLES & ANIMATIONS --- */
        *, *::before, *::after { box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: var(--font-main);
            background-color: var(--light-bg-secondary);
            color: var(--light-text-secondary);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .app-container {
            max-width: 72rem; /* 1152px */
            margin: 2rem auto;
            padding: 1.5rem;
            width: 100%; /* Ensure it takes full width on small screens */
        }
        h1, h2, h3 { font-weight: 600; color: var(--light-text-primary); margin: 0; }
        h1 { font-size: 1.875rem; line-height: 2.25rem; }
        h2 { font-size: 1.5rem; line-height: 2rem; }
        h3 { font-size: 1.25rem; line-height: 1.75rem; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        
        .screen { display: none; }
        .screen.active { display: block; animation: fadeUp 0.5s var(--ease) forwards; }

        /* --- 3. GLOBAL COMPONENTS (Buttons, Tags) --- */
        button, .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.625rem 1.25rem; /* 10px 20px */
            border-radius: var(--radius-md);
            font-weight: 600; font-size: 0.875rem;
            transition: all 0.2s var(--ease);
            border: 1px solid transparent; cursor: pointer;
            -webkit-user-select: none; user-select: none;
        }
        button:hover:not(:disabled), .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        button:active:not(:disabled), .btn:active:not(:disabled) { transform: translateY(0); box-shadow: var(--shadow-sm); }
        button:disabled, .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        button:focus-visible, .btn:focus-visible { outline: 2px solid var(--color-focus-ring); outline-offset: 2px; }

        .btn-primary { background-color: var(--color-primary); color: var(--color-primary-text); }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); }

        .btn-secondary { background-color: var(--light-bg-primary); color: var(--light-text-secondary); border-color: var(--light-border); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--light-bg-tertiary); border-color: var(--light-border-hover); color: var(--light-text-primary); }

        .btn-danger { background-color: var(--color-danger); color: var(--color-danger-text); }
        .btn-danger:hover:not(:disabled) { background-color: var(--color-danger-hover); }

        .btn-success { background-color: var(--color-accent); color: var(--color-accent-text); }
        .btn-success:hover:not(:disabled) { background-color: var(--color-accent-hover); }
        
        .btn-reopen { background-color: var(--color-reopen); color: var(--color-reopen-text); }
        .btn-reopen:hover:not(:disabled) { background-color: var(--color-reopen-hover); }
        
        .status-tag {
            display: inline-flex; align-items: center; gap: 0.375rem;
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;
        }
        .status-tag::before { content: ''; display: block; width: 0.5rem; height: 0.5rem; border-radius: 50%; }
        .status-tag.pending { background-color: var(--status-pending-bg); color: var(--status-pending-text); }
        .status-tag.pending::before { background-color: var(--status-pending-text); }
        .status-tag.completed { background-color: var(--status-completed-bg); color: var(--status-completed-text); }
        .status-tag.completed::before { background-color: var(--status-completed-text); }
        .status-tag.overdue { background-color: var(--status-overdue-bg); color: var(--status-overdue-text); }
        .status-tag.overdue::before { background-color: var(--status-overdue-text); }
        .status-tag.upcoming-due { background-color: var(--status-upcoming-bg); color: var(--status-upcoming-text); }
        .status-tag.upcoming-due::before { background-color: var(--status-upcoming-text); }

        /* --- 4. LAYOUT & CARDS --- */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem;
        }
        .page-header-left {
            display: flex; align-items: center; gap: 1rem;
        }
        .card {
            background-color: var(--light-bg-primary);
            border: 1px solid var(--light-border);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            box-shadow: var(--shadow-sm);
        }

        /* --- 5. FORM & INPUT STYLES (with Floating Labels) --- */
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } .form-grid .grid-col-span-2 { grid-column: span 2 / span 2; } }
        
        .input-group { position: relative; }
        .input-field {
            width: 100%; background-color: var(--light-bg-primary);
            border: 1px solid var(--light-border); border-radius: var(--radius-md);
            font-size: 1rem; padding: 1rem; color: var(--light-text-primary);
            transition: all 0.2s; outline: none;
        }
        .input-label {
            position: absolute; top: 1rem; left: 1rem;
            color: var(--light-text-secondary); pointer-events: none;
            transition: all 0.2s var(--ease);
            background-color: var(--light-bg-primary);
            padding: 0 0.25rem;
        }
        .input-field:focus + .input-label,
        .input-field:not(:placeholder-shown) + .input-label {
            top: -0.625rem; font-size: 0.75rem; color: var(--light-text-primary);
        }
        .input-field:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px var(--color-focus-ring); }
        
        .window-entry {
            border: 1px solid var(--light-border); padding: 1.5rem;
            margin-bottom: 1rem; border-radius: var(--radius-md);
            background-color: var(--light-bg-secondary); position: relative;
            display: grid; /* Use grid for layout */
            grid-template-columns: 1fr 1fr; /* Two columns for height and width */
            gap: 1rem;
            align-items: center; /* Vertically align items */
        }
        @media (min-width: 768px) {
            .window-entry { grid-template-columns: 1fr 1fr; }
        }
        .window-entry-header {
            grid-column: span 2; display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--light-border);
        }
        .window-entry-title { font-size: 1rem; font-weight: 600; color: var(--light-text-primary); }
        .remove-window-btn {
            background: none; border: none; padding: 0.25rem;
            color: var(--light-text-muted); cursor: pointer; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            transition: color 0.2s, background-color 0.2s;
            position: absolute; /* Position absolutely within the grid item */
            top: 0.5rem;
            right: 0.5rem;
            z-index: 10; /* Ensure it's above inputs if needed */
        }
        .remove-window-btn:hover { background-color: var(--light-bg-tertiary); color: var(--color-danger); }
        
        /* --- 6. ORDER LIST & SKELETON LOADER --- */
        .order-list-container {
            display: flex; /* Changed to flex */
            flex-direction: column; /* Stack vertically */
            gap: 1.5rem;
        }
        .order-card {
            background-color: white; border: 1px solid var(--light-border);
            border-radius: var(--radius-md); padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s var(--ease); cursor: pointer;
            display: flex; flex-direction: column; gap: 1rem;
        }
        .order-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--light-border-hover); }
        .order-card-header { display: flex; flex-direction: column; gap: 0.25rem; }
        .order-card-customer { font-size: 1.125rem; font-weight: 600; color: var(--light-text-primary); }
        .order-card-mobile { font-size: 0.875rem; color: var(--light-text-secondary); }
        .order-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 1rem; border-top: 1px dashed var(--light-border); }
        .order-card-date { font-size: 0.875rem; font-weight: 500; color: var(--light-text-primary); }

        .skeleton-card {
            background-color: var(--light-bg-primary); border: 1px solid var(--light-border);
            border-radius: var(--radius-md); padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        .skeleton {
            background-color: var(--light-bg-tertiary);
            border-radius: var(--radius-sm);
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton.h-6 { height: 1.5rem; } .skeleton.w-3_4 { width: 75%; }
        .skeleton.h-4 { height: 1rem; } .skeleton.w-1_2 { width: 50%; } .skeleton.w-1_3 { width: 33.33%; }
        .skeleton.mt-4 { margin-top: 1rem; } .skeleton.mt-2 { margin-top: 0.5rem; }

        /* --- 7. MODAL & OVERLAY STYLES --- */
        .modal {
            display: none; position: fixed; z-index: 1000;
            inset: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s var(--ease);
        }
        .modal-content {
            background-color: white; padding: 2rem;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
            width: 90%; max-width: 420px; text-align: center;
            animation: popIn 0.3s var(--ease);
        }
        .modal-message { font-size: 1.125rem; font-weight: 500; margin-bottom: 1.5rem; color: var(--light-text-primary); }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }

        .loading-overlay {
            position: fixed; inset: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.9); z-index: 1001;
            display: none; align-items: center; justify-content: center;
        }
        .spinner {
            border: 6px solid var(--light-bg-tertiary); border-top: 6px solid var(--color-primary);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        
        /* --- 8. RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 640px) {
            .app-container { margin: 0; padding: 1rem; }
            .page-header { flex-direction: column; gap: 1rem; align-items: stretch; }
            .card { padding: 1.5rem; }
            .order-list-container { grid-template-columns: 1fr; }
            .modal-content { width: calc(100% - 2rem); }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Login Screen (Initial View) -->
        <div id="login-screen" class="screen active text-center">
            <h1 style="margin-bottom: 0.5rem;">Welcome to uPVC Pro</h1>
            <p style="margin-bottom: 2rem; color: var(--light-text-muted);">Sign in to manage your orders.</p>
            <button id="google-sign-in-btn" class="btn-primary">
                <span class="material-symbols-outlined">account_circle</span>
                Sign in with Google
            </button>
        </div>

        <!-- Main Menu Screen (Hidden until login) -->
        <div id="main-menu" class="screen text-center">
            <h1 style="margin-bottom: 0.5rem;">uPVC Pro Dashboard</h1>
            <p style="margin-bottom: 2rem; color: var(--light-text-muted);">
                Logged in as: <span id="user-id-display" class="font-mono" style="color: var(--color-primary);">Loading...</span>
            </p>
            <!-- Upcoming & Overdue Orders Summary -->
            <div id="due-date-summary" class="card" style="margin-bottom: 2rem; text-align: left;">
                <h3 style="margin-bottom: 1rem;">Upcoming & Overdue Orders</h3>
                <ul id="upcoming-overdue-list" style="list-style-type: none; padding-left: 0; margin-bottom: 0;">
                    <!-- Summary items will be rendered here -->
                    <li style="color: var(--light-text-secondary);">No critical orders.</li>
                </ul>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 1rem;">
                <button id="add-new-btn" class="btn-primary">
                    <span class="material-symbols-outlined">add_circle</span>
                    Add New Order
                </button>
                <button id="view-orders-btn" class="btn-secondary">
                    <span class="material-symbols-outlined">view_list</span>
                    View All Orders
                </button>
                <button id="sign-out-btn" class="btn-secondary">
                    <span class="material-symbols-outlined">logout</span>
                    Sign Out
                </button>
            </div>
        </div>

        <!-- Add/Edit Order Screens -->
        <div id="form-screen" class="screen">
            <div class="page-header">
                <h2 id="form-title">Create New Order</h2>
                <button class="back-to-main btn-secondary">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back
                </button>
            </div>
            <div class="card">
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-border);">Customer Information</h3>
                    <div class="form-grid">
                        <div class="input-group">
                            <input type="text" id="customer-name" class="input-field" placeholder=" " required>
                            <label for="customer-name" class="input-label">Customer Name</label>
                        </div>
                        <div class="input-group">
                            <input type="tel" id="customer-mobile" class="input-field" placeholder=" " pattern="[0-9]{10}" title="10-digit mobile number" required>
                            <label for="customer-mobile" class="input-label">Mobile Number</label>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <textarea id="customer-address" rows="2" class="input-field" placeholder=" " required></textarea>
                            <label for="customer-address" class="input-label">Customer Address</label>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <input type="date" id="due-date" class="input-field" placeholder=" " required>
                            <label for="due-date" class="input-label">Due Date</label>
                        </div>
                    </div>

                    <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">Window Details</h3>
                    <div id="windows-container">
                        <!-- Window entries will be added here by JS -->
                    </div>
                    <button type="button" id="add-window-btn" class="btn-secondary" style="width: 100%; margin: 1rem 0;">
                        <span class="material-symbols-outlined">add</span>
                        Add Another Window
                    </button>
                    
                    <div style="display: flex; justify-content: flex-end; margin-top: 2rem; border-top: 1px solid var(--light-border); padding-top: 2rem;">
                        <button type="submit" id="save-order-btn" class="btn-success">
                            <span class="material-symbols-outlined">save</span>
                            Save Order
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Existing Orders Screen -->
        <div id="view-orders-screen" class="screen">
            <div class="page-header">
                <h2>All Orders</h2>
                <button class="back-to-main btn-secondary">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back
                </button>
            </div>
            
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="input-group">
                        <input type="text" id="order-search" class="input-field" placeholder=" ">
                        <label for="order-search" class="input-label">Search by name, address, or mobile...</label>
                    </div>
                    <div class="input-group">
                        <select id="order-filter" class="input-field" style="padding-top: 1rem; padding-bottom: 1rem;">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="overdue">Overdue</option>
                            <option value="upcoming-due">Upcoming Due</option>
                        </select>
                        <label for="order-filter" class="input-label">Filter by Status</label>
                    </div>
                </div>
            </div>

            <div id="order-list-container" class="order-list-container">
                <!-- Order cards or skeleton loaders will be listed here by JS -->
            </div>
            <div id="order-list-empty" class="text-center" style="display: none; padding: 3rem; background: var(--light-bg-tertiary); border-radius: var(--radius-lg);">
                <span class="material-symbols-outlined" style="font-size: 3rem; color: var(--light-text-muted);">folder_off</span>
                <p style="margin-top: 1rem; color: var(--light-text-secondary);">No orders found matching your criteria.</p>
            </div>
        </div>
        
        <!-- Order Details Screen -->
        <div id="order-details-screen" class="screen">
            <div class="page-header">
                <h2>Order Details</h2>
                <button class="back-to-view-orders btn-secondary">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back
                </button>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                    <div>
                        <p id="detail-customer-name" style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);"></p>
                        <p id="detail-customer-address" style="color: var(--light-text-secondary);"></p>
                    </div>
                    <div id="detail-status-tag" class="status-tag"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; font-size: 0.875rem;">
                    <p><strong>Mobile:</strong> <span id="detail-customer-mobile"></span></p>
                    <p><strong>Order Placed:</strong> <span id="detail-order-taken-date"></span></p>
                    <p><strong>Due Date:</strong> <span id="detail-due-date"></span></p>
                    <p id="detail-completed-date-row" style="display: none;"><strong>Completed:</strong> <span id="detail-completed-date"></span></p>
                    <p id="detail-created-by-row" style="display: none;"><strong>Created By:</strong> <span id="detail-created-by"></span></p>
                    <p id="detail-completed-by-row" style="display: none;"><strong>Completed By:</strong> <span id="detail-completed-by"></span></p>
                </div>

                <h3 style="margin-bottom: 1rem;">Windows (<span id="detail-window-count"></span>)</h3>
                <ul id="detail-windows-list" style="list-style-type: none; padding-left: 0; margin-bottom: 2rem; display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- Window details -->
                </ul>

                <div style="background: var(--light-bg-secondary); padding: 1rem; border-radius: var(--radius-md); text-align: center; font-weight: 600;">
                    Total Size - Width: <span id="detail-total-width" style="color: var(--color-primary);"></span> cm, Height: <span id="detail-total-height" style="color: var(--color-primary);"></span> cm
                </div>

                <div style="display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 0.75rem; margin-top: 2rem; border-top: 1px solid var(--light-border); padding-top: 2rem;">
                    <button id="detail-generate-pdf-btn" class="btn-secondary"><span class="material-symbols-outlined">picture_as_pdf</span>Generate PDF</button>
                    <button id="detail-delete-btn" class="btn-danger"><span class="material-symbols-outlined">delete</span>Delete</button>
                    <button id="detail-edit-btn" class="btn-primary"><span class="material-symbols-outlined">edit</span>Edit Order</button>
                    <button id="detail-complete-btn" class="btn-success"><span class="material-symbols-outlined">check_circle</span>Mark as Complete</button>
                </div>
            </div>
        </div>

        <!-- Edit Order Screen -->
        <div id="edit-order-screen" class="screen">
            <div class="page-header">
                <h2 id="edit-form-title">Edit Order</h2>
                <button class="back-to-view-orders btn-secondary">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back
                </button>
            </div>
            <div class="card">
                <form id="edit-form-actual">
                    <input type="hidden" id="edit-order-id">
                    <h3 style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--light-border);">Customer Information</h3>
                    <div class="form-grid">
                        <div class="input-group">
                            <input type="text" id="edit-customer-name" class="input-field" placeholder=" " required>
                            <label for="edit-customer-name" class="input-label">Customer Name</label>
                        </div>
                        <div class="input-group">
                            <input type="tel" id="edit-customer-mobile" class="input-field" placeholder=" " pattern="[0-9]{10}" title="10-digit mobile number" required>
                            <label for="edit-customer-mobile" class="input-label">Mobile Number</label>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <textarea id="edit-customer-address" rows="2" class="input-field" placeholder=" " required></textarea>
                            <label for="edit-customer-address" class="input-label">Customer Address</label>
                        </div>
                        <div class="input-group grid-col-span-2">
                            <input type="date" id="edit-due-date" class="input-field" placeholder=" " required>
                            <label for="edit-due-date" class="input-label">Due Date</label>
                        </div>
                    </div>

                    <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">Window Details</h3>
                    <div id="edit-windows-container">
                        <!-- Window entries will be added here by JS -->
                    </div>
                    <button type="button" id="add-edit-window-btn" class="btn-secondary" style="width: 100%; margin: 1rem 0;">
                        <span class="material-symbols-outlined">add</span>
                        Add Another Window
                    </button>
                    
                    <div style="display: flex; justify-content: flex-end; margin-top: 2rem; border-top: 1px solid var(--light-border); padding-top: 2rem;">
                        <button type="submit" id="update-order-btn" class="btn-success">
                            <span class="material-symbols-outlined">save</span>
                            Update Order
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="modal-message"></p>
            <div class="modal-buttons">
                <button id="cancel-action-btn" class="btn-secondary">Cancel</button>
                <button id="confirm-action-btn" class="btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text" class="modal-message"></p>
            <button id="message-ok-btn" class="btn-primary" style="min-width: 120px;">OK</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script type="module">
        // Import Firebase modules directly from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, collection, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Use a self-executing anonymous function to encapsulate the script
        (function() {
            // --- CACHED DOM ELEMENTS ---
            // These are now initialized inside initializeFirebase or onAuthStateChanged
            // to ensure they exist when accessed.
            let mainMenuScreen, formScreen, viewOrdersScreen, orderDetailsScreen, loginScreen;
            let formTitle, orderForm, orderIdInput, customerNameInput, customerAddressInput, customerMobileInput, dueDateInput, windowsContainer, addWindowBtn, saveOrderBtn;
            let orderListContainer, orderListEmpty, userIdDisplay, orderSearchInput, orderFilterSelect, upcomingOverdueList;
            let googleSignInBtn, signOutBtn;
            let detailCustomerName, detailCustomerAddress, detailCustomerMobile, detailOrderTakenDate, detailDueDate, detailStatusTag, detailCompletedDateRow, detailCompletedDate, detailCreatedByRow, detailCreatedBy, detailCompletedByRow, detailCompletedBy, detailWindowsList, detailWindowCount, detailTotalWidth, detailTotalHeight, detailEditBtn, detailDeleteBtn, detailGeneratePdfBtn, detailCompleteBtn;
            let confirmationModal, modalMessage, confirmActionBtn, cancelActionBtn;
            let messageModal, messageText, messageOkBtn;
            let loadingOverlay;

            // --- APP STATE ---
            let orders = [];
            let currentAction = { type: null, id: null, callback: null };
            let currentViewedOrderId = null;
            let db, auth;
            let currentUserId = null;
            let currentUserName = "Unknown User"; // Default name
            
            // --- UI & UX FUNCTIONS ---
            const showLoading = () => loadingOverlay.style.display = 'flex';
            const hideLoading = () => loadingOverlay.style.display = 'none';

            const showMessageModal = (message) => {
                messageText.textContent = message;
                messageModal.style.display = 'flex';
            };

            const showConfirmationModal = (message, confirmClass, confirmText, actionType, orderId, callback) => {
                modalMessage.textContent = message;
                confirmActionBtn.className = 'btn'; // Reset classes
                confirmActionBtn.classList.add(confirmClass);
                confirmActionBtn.textContent = confirmText;
                currentAction = { type: actionType, id: orderId, callback: callback };
                confirmationModal.style.display = 'flex';
            };
            
            const hideConfirmationModal = () => {
                confirmationModal.style.display = 'none';
            };

            const showScreen = (screenToShow) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                screenToShow.classList.add('active');
                // Special handling for main menu to re-render critical alerts
                if (screenToShow === mainMenuScreen) {
                    populateUpcomingOverdueList();
                }
            };

            const createSkeletonCard = () => `
                <div class="skeleton-card">
                    <div class="skeleton h-6 w-3_4"></div>
                    <div class="skeleton h-4 w-1_2 mt-2"></div>
                    <div class="skeleton h-4 w-1_3 mt-4"></div>
                </div>`;

            const showSkeletonLoaders = (count = 6) => {
                orderListContainer.innerHTML = Array(count).fill(createSkeletonCard()).join('');
                orderListContainer.style.display = 'grid';
                orderListEmpty.style.display = 'none';
            };

            const addWindowInput = (container, index, height = '', width = '') => {
                const windowEntryDiv = document.createElement('div');
                windowEntryDiv.className = 'window-entry';
                windowEntryDiv.innerHTML = `
                    <div class="window-entry-header">
                        <span class="window-entry-title">Window #${index}</span>
                        <button type="button" class="remove-window-btn"><span class="material-symbols-outlined">close</span></button>
                    </div>
                    <div class="input-group">
                        <input type="number" class="window-height-input input-field" value="${height}" min="0.1" step="0.1" placeholder=" " required>
                        <label class="input-label">Height (cm)</label>
                    </div>
                    <div>
                        <div class="input-group">
                            <input type="number" class="window-width-input input-field" value="${width}" min="0.1" step="0.1" placeholder=" " required>
                            <label class="input-label">Width (cm)</label>
                        </div>
                    </div>
                `;
                container.appendChild(windowEntryDiv);
                windowEntryDiv.querySelector('.remove-window-btn').addEventListener('click', () => {
                    windowEntryDiv.remove();
                    updateWindowTitles(container);
                });
            };

            const updateWindowTitles = (container) => {
                container.querySelectorAll('.window-entry').forEach((entry, index) => {
                    entry.querySelector('.window-entry-title').textContent = `Window #${index + 1}`;
                });
            };

            const setupFormForCreate = () => {
                if (formTitle) formTitle.textContent = 'Create New Order'; // Defensive check
                if (saveOrderBtn) saveOrderBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Order'; // Defensive check
                if (orderForm) orderForm.reset(); // Defensive check
                if (orderIdInput) orderIdInput.value = ''; // Defensive check
                if (windowsContainer) windowsContainer.innerHTML = ''; // Defensive check
                if (windowsContainer) addWindowInput(windowsContainer, 1); // Defensive check
                showScreen(formScreen);
            };

            const setupFormForEdit = (order) => {
                formTitle.textContent = 'Edit Order';
                saveOrderBtn.innerHTML = '<span class="material-symbols-outlined">update</span> Update Order';
                orderForm.reset();
                orderIdInput.value = order.id;
                customerNameInput.value = order.name;
                customerAddressInput.value = order.address;
                customerMobileInput.value = order.mobileNumber || '';
                dueDateInput.value = order.dueDate || '';
                windowsContainer.innerHTML = '';
                let windowsToLoad = [];
                if (typeof order.windows === 'string') {
                    try { windowsToLoad = JSON.parse(order.windows); } catch (e) { windowsToLoad = []; }
                } else if (Array.isArray(order.windows)) {
                    windowsToLoad = order.windows;
                }

                if (windowsToLoad.length > 0) {
                    windowsToLoad.forEach((win, index) => addWindowInput(windowsContainer, index + 1, win.height, win.width));
                } else {
                    addWindowInput(windowsContainer, 1);
                }
                showScreen(formScreen);
            };

            // --- DATA & RENDERING FUNCTIONS ---
            const getStatusInfo = (order, today) => {
                if (order.status === 'completed') {
                    return { text: 'Completed', className: 'completed' };
                }
                const dueDate = order.dueDate ? new Date(order.dueDate + 'T00:00:00') : null; // Ensure date is parsed correctly
                if (dueDate && dueDate < today) {
                    return { text: 'Overdue', className: 'overdue' };
                }
                if (dueDate) {
                    const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    if (daysDiff >= 0 && daysDiff <= 3) {
                        return { text: `Due in ${daysDiff} day${daysDiff !== 1 ? 's' : ''}`, className: 'upcoming-due' };
                    }
                }
                return { text: 'Pending', className: 'pending' };
            };
            
            const renderOrderList = () => {
                const searchQuery = orderSearchInput.value.toLowerCase();
                const filterStatus = orderFilterSelect.value;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const filteredOrders = orders.filter(order => {
                    const matchesSearch = 
                        order.name.toLowerCase().includes(searchQuery) ||
                        order.address.toLowerCase().includes(searchQuery) ||
                        (order.mobileNumber && order.mobileNumber.includes(searchQuery));

                    const statusInfo = getStatusInfo(order, today);
                    let matchesFilter = false;
                    if (filterStatus === 'all') {
                        matchesFilter = true;
                    } else if (filterStatus === 'pending') {
                        matchesFilter = statusInfo.className === 'pending';
                    } else if (filterStatus === 'completed') {
                        matchesFilter = statusInfo.className === 'completed';
                    } else if (filterStatus === 'overdue') {
                        matchesFilter = statusInfo.className === 'overdue';
                    } else if (filterStatus === 'upcoming-due') {
                        matchesFilter = statusInfo.className === 'upcoming-due';
                    }
                    return matchesSearch && matchesFilter;
                });
                
                orderListContainer.innerHTML = '';
                if (filteredOrders.length === 0) {
                    orderListEmpty.style.display = 'block';
                    orderListContainer.style.display = 'none';
                    return;
                }

                orderListEmpty.style.display = 'none';
                orderListContainer.style.display = 'flex'; 
                orderListContainer.style.flexDirection = 'column';

                filteredOrders
                    .sort((a, b) => {
                        const dateA = a.dueDate ? new Date(a.dueDate) : null;
                        const dateB = b.dueDate ? new Date(b.dueDate) : null;
                        const statusA = getStatusInfo(a, today).className;
                        const statusB = getStatusInfo(b, today).className;

                        // Custom sorting logic: Overdue -> Upcoming -> Pending -> Completed
                        const statusOrder = { 'overdue': 1, 'upcoming-due': 2, 'pending': 3, 'completed': 4 };
                        if (statusOrder[statusA] !== statusOrder[statusB]) {
                            return statusOrder[statusA] - statusOrder[statusB];
                        }
                        // Then by date
                        return (dateA?.getTime() || 0) - (dateB?.getTime() || 0);
                    })
                    .forEach(order => {
                        const card = document.createElement('div');
                        card.className = 'order-card';
                        card.dataset.id = order.id;
                        const statusInfo = getStatusInfo(order, today);

                        card.innerHTML = `
                            <div class="order-card-header">
                                <span class="order-card-customer">${order.name}</span>
                                <span class="order-card-mobile">${order.mobileNumber || 'No mobile'}</span>
                            </div>
                            <div class="status-tag ${statusInfo.className}">${statusInfo.text}</div>
                            <div class="order-card-footer">
                                <span class="order-card-date">Due: ${order.dueDate || 'Not set'}</span>
                                <span class="material-symbols-outlined" style="color: var(--light-text-muted);">arrow_forward_ios</span>
                            </div>
                        `;
                        card.addEventListener('click', () => showOrderDetails(order.id));
                        orderListContainer.appendChild(card);
                    });
                
                // Update total width/height displays (these are for all orders, not filtered)
                let totalWidthAll = 0;
                let totalHeightAll = 0;
                orders.forEach(order => {
                    let currentWindows = order.windows;
                    if (typeof currentWindows === 'string') {
                        try { currentWindows = JSON.parse(currentWindows); } catch(e) { currentWindows = []; }
                    }
                    currentWindows.forEach(win => {
                        totalWidthAll += parseFloat(win.width || 0);
                        totalHeightAll += parseFloat(win.height || 0);
                    });
                });
                // Ensure elements exist before setting textContent
                if (document.getElementById('total-width-display')) document.getElementById('total-width-display').textContent = totalWidthAll.toFixed(1);
                if (document.getElementById('total-height-display')) document.getElementById('total-height-display').textContent = totalHeightAll.toFixed(1);

                populateUpcomingOverdueList(); // Always update critical list based on all orders
            };

            const populateUpcomingOverdueList = () => {
                upcomingOverdueList.innerHTML = '';
                const today = new Date(); today.setHours(0,0,0,0);

                const criticalOrders = orders.filter(order => {
                    if (order.status === 'completed') return false;
                    const dueDate = order.dueDate ? new Date(order.dueDate + 'T00:00:00') : null;
                    if (!dueDate) return false;
                    const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                    return (dueDate < today) || (daysDiff >= 0 && daysDiff <= 3);
                }).sort((a,b) => (new Date(a.dueDate)?.getTime() || 0) - (new Date(b.dueDate)?.getTime() || 0));

                if (criticalOrders.length === 0) {
                    upcomingOverdueList.innerHTML = '<li style="color: var(--light-text-secondary);">No critical orders.</li>';
                } else {
                    criticalOrders.forEach(order => {
                        const dueDate = new Date(order.dueDate);
                        const daysDiff = Math.ceil((dueDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
                        let summaryText = '';
                        let summaryColor = '';

                        if (dueDate < today) {
                            summaryText = `Overdue (${order.dueDate})`;
                            summaryColor = 'var(--status-overdue-text)';
                        } else {
                            summaryText = `Due in ${daysDiff} day${daysDiff !== 1 ? 's' : ''} (${order.dueDate})`;
                            summaryColor = 'var(--status-upcoming-text)';
                        }
                        const li = document.createElement('li');
                        li.style.color = summaryColor;
                        li.innerHTML = `<span style="font-weight: 600;">${order.name}</span> - ${summaryText}`;
                        upcomingOverdueList.appendChild(li);
                    });
                }
            };
            
            const showOrderDetails = (orderId) => {
                currentViewedOrderId = orderId;
                const order = orders.find(o => o.id === orderId);
                if (!order) { showMessageModal('Order details not found.'); return; }
                
                detailCustomerName.textContent = order.name;
                detailCustomerAddress.textContent = order.address;
                detailCustomerMobile.textContent = order.mobileNumber || 'N/A';
                detailOrderTakenDate.textContent = order.createdAt?.toDate ? new Date(order.createdAt.toDate()).toLocaleDateString() : 'N/A';
                detailDueDate.textContent = order.dueDate || 'N/A';
                
                const today = new Date(); today.setHours(0,0,0,0);
                const statusInfo = getStatusInfo(order, today);
                detailStatusTag.className = 'status-tag ' + statusInfo.className;
                detailStatusTag.textContent = statusInfo.text;
                
                detailCompletedDateRow.style.display = (order.status === 'completed' && order.completedAt) ? 'block' : 'none';
                detailCompletedDate.textContent = (order.status === 'completed' && order.completedAt?.toDate) ? new Date(order.completedAt.toDate()).toLocaleDateString() : '';

                detailCreatedByRow.style.display = order.createdBy ? 'block' : 'none';
                detailCreatedBy.textContent = order.createdBy || '';

                detailCompletedByRow.style.display = (order.completedBy && order.status === 'completed') ? 'block' : 'none';
                detailCompletedBy.textContent = order.completedBy || '';

                let windowsToDisplay = [];
                if (typeof order.windows === 'string') { try { windowsToDisplay = JSON.parse(order.windows); } catch(e) {} }
                else if (Array.isArray(order.windows)) { windowsToDisplay = order.windows; }
                
                detailWindowsList.innerHTML = '';
                let totalW = 0, totalH = 0;
                if(windowsToDisplay.length > 0) {
                    windowsToDisplay.forEach((win, i) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span style="font-weight: 600;">Window ${i+1}:</span> H: ${win.height} cm, W: ${win.width} cm`;
                        detailWindowsList.appendChild(li);
                        totalW += parseFloat(win.width || 0);
                        totalH += parseFloat(win.height || 0);
                    });
                } else {
                    detailWindowsList.innerHTML = '<li>No window details available.</li>';
                }
                detailWindowCount.textContent = windowsToDisplay.length;
                detailTotalWidth.textContent = totalW.toFixed(1);
                detailTotalHeight.textContent = totalH.toFixed(1);

                detailEditBtn.dataset.id = order.id;
                detailDeleteBtn.dataset.id = order.id;
                detailGeneratePdfBtn.dataset.id = order.id;
                detailCompleteBtn.dataset.id = order.id;

                if (order.status === 'completed') {
                    detailCompleteBtn.innerHTML = '<span class="material-symbols-outlined">refresh</span>Reopen Order';
                    detailCompleteBtn.className = 'btn btn-reopen';
                    detailEditBtn.disabled = true;
                } else {
                    detailCompleteBtn.innerHTML = '<span class="material-symbols-outlined">check_circle</span>Mark as Complete';
                    detailCompleteBtn.className = 'btn btn-success';
                    detailEditBtn.disabled = false;
                }

                showScreen(orderDetailsScreen);
            };

            const generateOrderPdf = (orderId) => {
                const order = orders.find(o => o.id === orderId);
                if (!order) { showMessageModal('Order not found for PDF generation.'); return; }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20, margin = 15, lineHeight = 8;
                doc.setFont("IBM Plex Sans", "bold").setFontSize(20).text("uPVC Order Confirmation", 105, yPos, { align: 'center' });
                yPos += lineHeight * 2;
                doc.setLineWidth(0.5).line(margin, yPos, 210 - margin, yPos);
                yPos += lineHeight;

                doc.setFont("IBM Plex Sans", "bold").setFontSize(12).text("Customer:", margin, yPos);
                doc.setFont("IBM Plex Sans", "normal").text(order.name, margin + 40, yPos);
                yPos += lineHeight;
                doc.setFont("IBM Plex Sans", "bold").text("Address:", margin, yPos);
                doc.setFont("IBM Plex Sans", "normal").text(order.address, margin + 40, yPos);
                yPos += lineHeight;
                doc.setFont("IBM Plex Sans", "bold").text("Mobile:", margin, yPos);
                doc.setFont("IBM Plex Sans", "normal").text(order.mobileNumber || 'N/A', margin + 40, yPos);
                yPos += lineHeight * 2;

                doc.setFont("IBM Plex Sans", "bold").text("Order Date:", margin, yPos);
                doc.setFont("IBM Plex Sans", "normal").text(order.createdAt?.toDate ? new Date(order.createdAt.toDate()).toLocaleDateString() : 'N/A', margin + 40, yPos);
                yPos += lineHeight;
                doc.setFont("IBM Plex Sans", "bold").text("Due Date:", margin, yPos);
                doc.setFont("IBM Plex Sans", "normal").text(order.dueDate || 'N/A', margin + 40, yPos);
                yPos += lineHeight;

                if (order.status === 'completed' && order.completedAt) {
                    doc.setFont("IBM Plex Sans", "bold").text("Completed Date:", margin, yPos);
                    doc.setFont("IBM Plex Sans", "normal").text(new Date(order.completedAt.toDate()).toLocaleDateString(), margin + 40, yPos);
                    yPos += lineHeight;
                }
                if (order.createdBy) {
                    doc.setFont("IBM Plex Sans", "bold").text("Created By:", margin, yPos);
                    doc.setFont("IBM Plex Sans", "normal").text(order.createdBy, margin + 40, yPos);
                    yPos += lineHeight;
                }
                if (order.completedBy && order.status === 'completed') {
                    doc.setFont("IBM Plex Sans", "bold").text("Completed By:", margin, yPos);
                    doc.setFont("IBM Plex Sans", "normal").text(order.completedBy, margin + 40, yPos);
                    yPos += lineHeight;
                }
                yPos += lineHeight; // Extra space before window details

                doc.setLineWidth(0.2).line(margin, yPos, 210 - margin, yPos);
                yPos += lineHeight;

                doc.setFont("IBM Plex Sans", "bold").setFontSize(14).text("Window Specifications", margin, yPos);
                yPos += lineHeight;

                let windowsForPdf = [];
                if (typeof order.windows === 'string') { try { windowsForPdf = JSON.parse(order.windows); } catch(e){} }
                else if (Array.isArray(order.windows)) { windowsForPdf = order.windows; }
                
                let orderTotalWidth = 0, orderTotalHeight = 0;
                windowsForPdf.forEach((win, index) => {
                    doc.setFont("IBM Plex Sans", "normal").setFontSize(12);
                    doc.text(`Window ${index + 1}:`, margin + 5, yPos);
                    doc.text(`Height: ${win.height} cm`, margin + 40, yPos);
                    doc.text(`Width: ${win.width} cm`, margin + 90, yPos);
                    yPos += lineHeight;
                    orderTotalWidth += parseFloat(win.width || 0);
                    orderTotalHeight += parseFloat(win.height || 0);
                    if (yPos > 270) { doc.addPage(); yPos = 20; }
                });

                yPos += lineHeight;
                doc.setLineWidth(0.2).line(margin, yPos, 210 - margin, yPos);
                yPos += lineHeight;
                
                doc.setFont("IBM Plex Sans", "bold").setFontSize(14);
                doc.text(`Total Width: ${orderTotalWidth.toFixed(1)} cm`, margin, yPos);
                yPos += lineHeight;
                doc.text(`Total Height: ${orderTotalHeight.toFixed(1)} cm`, margin, yPos);

                doc.save(`Order_${order.name.replace(/\s/g, '_')}.pdf`);
            };

            // --- FIREBASE & CORE LOGIC ---
            async function initializeFirebase() {
                try {
                    // Your web app's Firebase configuration
                    const firebaseConfig = {
                      apiKey: "AIzaSyBp4XoqX-MYvOlweR5dPfEqAP9qXu2P81E",
                      authDomain: "harsha-jw.firebaseapp.com",
                      projectId: "harsha-jw",
                      storageBucket: "harsha-jw.appspot.com",
                      messagingSenderId: "471408120499",
                      appId: "1:471408120499:web:91e61514ad3703ce3b16c6",
                      measurementId: "G-NBC16X4R1T"
                    };

                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // Initialize DOM elements here, after Firebase app is created
                    mainMenuScreen = document.getElementById('main-menu');
                    formScreen = document.getElementById('form-screen');
                    viewOrdersScreen = document.getElementById('view-orders-screen');
                    orderDetailsScreen = document.getElementById('order-details-screen');
                    loginScreen = document.getElementById('login-screen'); 

                    formTitle = document.getElementById('form-title');
                    orderForm = document.getElementById('order-form');
                    orderIdInput = document.getElementById('order-id');
                    customerNameInput = document.getElementById('customer-name');
                    customerAddressInput = document.getElementById('customer-address');
                    customerMobileInput = document.getElementById('customer-mobile');
                    dueDateInput = document.getElementById('due-date');
                    windowsContainer = document.getElementById('windows-container');
                    addWindowBtn = document.getElementById('add-window-btn');
                    saveOrderBtn = document.getElementById('save-order-btn');
                    
                    orderListContainer = document.getElementById('order-list-container');
                    orderListEmpty = document.getElementById('order-list-empty');
                    userIdDisplay = document.getElementById('user-id-display');
                    orderSearchInput = document.getElementById('order-search');
                    orderFilterSelect = document.getElementById('order-filter');
                    upcomingOverdueList = document.getElementById('upcoming-overdue-list');

                    googleSignInBtn = document.getElementById('google-sign-in-btn'); 
                    signOutBtn = document.getElementById('sign-out-btn'); 

                    detailCustomerName = document.getElementById('detail-customer-name');
                    detailCustomerAddress = document.getElementById('detail-customer-address');
                    detailCustomerMobile = document.getElementById('detail-customer-mobile');
                    detailOrderTakenDate = document.getElementById('detail-order-taken-date');
                    detailDueDate = document.getElementById('detail-due-date');
                    detailStatusTag = document.getElementById('detail-status-tag');
                    detailCompletedDateRow = document.getElementById('detail-completed-date-row');
                    detailCompletedDate = document.getElementById('detail-completed-date');
                    detailCreatedByRow = document.getElementById('detail-created-by-row');
                    detailCreatedBy = document.getElementById('detail-created-by');
                    detailCompletedByRow = document.getElementById('detail-completed-by-row');
                    detailCompletedBy = document.getElementById('detail-completed-by');
                    detailWindowsList = document.getElementById('detail-windows-list');
                    detailWindowCount = document.getElementById('detail-window-count');
                    detailTotalWidth = document.getElementById('detail-total-width');
                    detailTotalHeight = document.getElementById('detail-total-height');
                    detailEditBtn = document.getElementById('detail-edit-btn');
                    detailDeleteBtn = document.getElementById('detail-delete-btn');
                    detailGeneratePdfBtn = document.getElementById('detail-generate-pdf-btn');
                    detailCompleteBtn = document.getElementById('detail-complete-btn');

                    confirmationModal = document.getElementById('confirmation-modal');
                    modalMessage = document.getElementById('modal-message');
                    confirmActionBtn = document.getElementById('confirm-action-btn');
                    cancelActionBtn = document.getElementById('cancel-action-btn');

                    messageModal = document.getElementById('message-modal');
                    messageText = document.getElementById('message-text');
                    messageOkBtn = document.getElementById('message-ok-btn');
                    loadingOverlay = document.getElementById('loading-overlay');


                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            // Use user.displayName from Google if available, otherwise fallback
                            await fetchOrCreateUserProfile(user.uid, user.displayName); 
                            listenForOrders();
                            showScreen(mainMenuScreen); // Show main menu after login
                        } else {
                            showScreen(loginScreen); // Show login screen if not authenticated
                        }
                    });
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    showMessageModal("Critical error initializing the application. Please refresh.");
                }
            }

            // Handles Google Sign-In
            async function handleGoogleSignIn() {
                showLoading();
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    // User signed in, onAuthStateChanged will handle the rest
                    showMessageModal(`Welcome, ${result.user.displayName || result.user.email}!`);
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showMessageModal("Sign-in cancelled. Please try again.");
                    } else if (error.code === 'auth/cancelled-popup-request') {
                         showMessageModal("Sign-in already in progress. Please wait.");
                    }
                    else {
                        showMessageModal(`Sign-in failed: ${error.message}`);
                    }
                } finally {
                    hideLoading();
                }
            }

            // Handles Sign Out
            async function handleSignOut() {
                showLoading();
                try {
                    await signOut(auth);
                    showMessageModal("You have been signed out.");
                    // onAuthStateChanged will handle screen transition
                } catch (error) {
                    console.error("Sign Out Error:", error);
                    showMessageModal("Failed to sign out. Please try again.");
                } finally {
                    hideLoading();
                }
            }


            async function fetchOrCreateUserProfile(userId, googleDisplayName) {
                // Use the hardcoded appId from your firebaseConfig for user_profiles access
                // This matches your working security rule: match /artifacts/default-app-id/user_profiles/{userId}
                const userProfileRef = doc(db, `artifacts/default-app-id/user_profiles`, userId);
                try {
                    const userDoc = await getDoc(userProfileRef);
                    if (userDoc.exists() && userDoc.data().userName) {
                        currentUserName = userDoc.data().userName;
                    } else {
                        // If profile doesn't exist, use Google display name or fallback
                        currentUserName = googleDisplayName || "Anonymous User";
                        await setDoc(userProfileRef, { userName: currentUserName, createdAt: serverTimestamp() }, { merge: true });
                        // showMessageModal("User profile created/updated!"); // Removed to avoid extra popup on login
                    }
                } catch (error) {
                    console.error("User Profile Error:", error);
                    showMessageModal("Could not load user profile. Please check Firebase security rules for 'user_profiles' collection.");
                } finally {
                    userIdDisplay.textContent = currentUserName;
                    // hideLoading() is now called in onAuthStateChanged for initial load
                }
            }

            function getOrdersCollectionRef() {
                // This path must match your Firestore security rules
                return collection(db, `upvc_orders`); // This matches your provided rule
            }

            let unsubscribe;
            function listenForOrders() {
                if(unsubscribe) unsubscribe(); // Unsubscribe from previous listener if any
                showSkeletonLoaders();
                // Only attempt to listen for orders if a user is logged in
                if (currentUserId) {
                    const ordersCollectionRef = getOrdersCollectionRef();
                    unsubscribe = onSnapshot(ordersCollectionRef, (snapshot) => {
                        orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderOrderList();
                        if (currentViewedOrderId) { // Refresh details if viewing an order
                            const updatedOrder = orders.find(o => o.id === currentViewedOrderId);
                            if (updatedOrder) showOrderDetails(currentViewedOrderId);
                            else { currentViewedOrderId = null; showScreen(viewOrdersScreen); }
                        }
                    }, (error) => {
                        console.error("Firestore Snapshot Error:", error);
                        showMessageModal("Error fetching real-time data.");
                    });
                } else {
                    // If no user, clear orders and stop listening
                    orders = [];
                    renderOrderList(); // Render empty list
                    populateUpcomingOverdueList(); // Clear critical alerts
                    hideLoading(); // Ensure loading is hidden if no data to fetch
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                showLoading();
                
                const orderId = orderIdInput.value;
                const isUpdating = !!orderId;
                
                const windowsData = Array.from(windowsContainer.querySelectorAll('.window-entry')).map(entry => ({
                    height: entry.querySelector('.window-height-input').value,
                    width: entry.querySelector('.window-width-input').value,
                }));

                // Basic validation for customer name, mobile, address, due date
                if (!customerNameInput.value.trim()) {
                    showMessageModal("Customer Name is required.");
                    hideLoading();
                    return;
                }
                if (!customerAddressInput.value.trim()) {
                    showMessageModal("Customer Address is required.");
                    hideLoading();
                    return;
                }
                // Mobile number pattern validation (already in HTML, but double-check here)
                const mobilePattern = /^[0-9]{10}$/;
                if (!mobilePattern.test(customerMobileInput.value.trim())) {
                    showMessageModal("Please enter a valid 10-digit mobile number.");
                    hideLoading();
                    return;
                }
                if (!dueDateInput.value) {
                    showMessageModal("Due Date is required.");
                    hideLoading();
                    return;
                }

                // Validate window dimensions
                let allWindowsValid = true;
                if (windowsData.length === 0) {
                    allWindowsValid = false;
                    showMessageModal("Please add at least one window entry.");
                    hideLoading();
                    return;
                }
                for (const win of windowsData) {
                    if (isNaN(parseFloat(win.height)) || parseFloat(win.height) <= 0 ||
                        isNaN(parseFloat(win.width)) || parseFloat(win.width) <= 0) {
                        allWindowsValid = false;
                        showMessageModal("Please ensure all window height and width values are positive numbers.");
                        hideLoading();
                        return;
                    }
                }
                if (!allWindowsValid) { // Redundant if checks above return, but good for safety
                    return;
                }


                const orderData = {
                    name: customerNameInput.value.trim(),
                    address: customerAddressInput.value.trim(),
                    mobileNumber: customerMobileInput.value.trim(),
                    dueDate: dueDateInput.value,
                    windows: JSON.stringify(windowsData),
                    [isUpdating ? 'updatedAt' : 'createdAt']: serverTimestamp(),
                    ...(isUpdating ? {} : { status: 'pending', createdBy: currentUserName, createdByUid: currentUserId }) // Store createdByUid
                };

                try {
                    const collectionRef = getOrdersCollectionRef();
                    if(isUpdating) {
                        await updateDoc(doc(collectionRef, orderId), orderData);
                    } else {
                        await addDoc(collectionRef, orderData);
                    }
                    showMessageModal(`Order successfully ${isUpdating ? 'updated' : 'saved'}!`);
                    showScreen(viewOrdersScreen);
                } catch (error) {
                    console.error("Error saving order: ", error);
                    showMessageModal("Failed to save order. Please check console and try again.");
                } finally {
                    hideLoading();
                }
            }
            
            async function performConfirmedAction() {
                hideConfirmationModal();
                showLoading();

                try {
                    const collectionRef = getOrdersCollectionRef();
                    const docRef = doc(collectionRef, currentAction.id);
                    await currentAction.callback(docRef);
                } catch (error) {
                    console.error(`Error performing action '${currentAction.type}':`, error);
                    showMessageModal(`Action failed. Please try again.`);
                } finally {
                    currentAction = { type: null, id: null, callback: null };
                    hideLoading();
                }
            }

            // --- EVENT LISTENERS ---
            // Login button listener (only visible on login screen)
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            }
            // Sign out button listener (only visible on main menu)
            if (signOutBtn) {
                signOutBtn.addEventListener('click', handleSignOut);
            }

            document.getElementById('add-new-btn').addEventListener('click', setupFormForCreate);
            document.getElementById('view-orders-btn').addEventListener('click', () => showScreen(viewOrdersScreen));
            document.querySelectorAll('.back-to-main').forEach(btn => btn.addEventListener('click', () => showScreen(mainMenuScreen)));
            document.querySelectorAll('.back-to-view-orders').forEach(btn => btn.addEventListener('click', () => showScreen(viewOrdersScreen)));
            
            addWindowBtn.addEventListener('click', () => addWindowInput(windowsContainer, windowsContainer.children.length + 1));
            orderForm.addEventListener('submit', handleFormSubmit);

            orderSearchInput.addEventListener('input', renderOrderList);
            orderFilterSelect.addEventListener('change', renderOrderList);

            detailEditBtn.addEventListener('click', (e) => {
                const orderId = e.currentTarget.dataset.id;
                const order = orders.find(o => o.id === orderId);
                if (order) setupFormForEdit(order);
            });
            
            detailDeleteBtn.addEventListener('click', (e) => {
                const orderId = e.currentTarget.dataset.id;
                showConfirmationModal(
                    'Are you sure you want to delete this order? This action is permanent.', 
                    'btn-danger', 'Delete Order', 'delete', orderId,
                    async (docRef) => {
                        await deleteDoc(docRef);
                        showMessageModal('Order deleted successfully.');
                        showScreen(viewOrdersScreen);
                    }
                );
            });

            detailCompleteBtn.addEventListener('click', (e) => {
                const orderId = e.currentTarget.dataset.id;
                const order = orders.find(o => o.id === orderId);
                if (!order) {
                    showMessageModal('Error: Order details not found.');
                    return;
                }

                if (order.status === 'completed') {
                    showConfirmationModal(
                        'This will mark the order as pending again. Are you sure?',
                        'btn-reopen', 'Reopen Order', 'reopen_to_edit', orderId,
                        async (docRef) => {
                            await updateDoc(docRef, { status: 'pending', completedAt: deleteField(), completedBy: deleteField() });
                            showMessageModal('Order has been reopened.');
                        }
                    );
                } else {
                    showConfirmationModal(
                        'Mark this order as complete?',
                        'btn-success', 'Mark Complete', 'complete', orderId,
                        async (docRef) => {
                            await updateDoc(docRef, { status: 'completed', completedAt: serverTimestamp(), completedBy: currentUserName });
                            showMessageModal('Order marked as complete!');
                        }
                    );
                }
            });

            detailGeneratePdfBtn.addEventListener('click', (e) => generateOrderPdf(e.currentTarget.dataset.id));
            
            messageOkBtn.addEventListener('click', () => messageModal.style.display = 'none');
            cancelActionBtn.addEventListener('click', () => confirmationModal.style.display = 'none');
            confirmActionBtn.addEventListener('click', performConfirmedAction);

            // --- INITIALIZATION ---
            initializeFirebase();
            addWindowInput(windowsContainer, 1);
        })();
    </script>
</body>
</html>
